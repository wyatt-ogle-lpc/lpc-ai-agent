<%# app/views/agents/ask.html.erb %>

<%= javascript_import_module_tag "llm_chat" %>

<div class="llm-app-container">
  <!-- Sidebar -->
  <div class="llm-sidebar">
    <div class="sidebar-header">
      <h2>Conversations</h2>
      <button id="sidebar-toggle" class="sidebar-toggle">☰</button>
    </div>
      <ul class="conversation-list">
        <% @conversations.each do |conv| %>
          <% safe_title   = conv.title.gsub(/\*\*(.+?)\*\*/, '<span class="markdown-bold">\1</span>').html_safe %>
          <% tooltip_title = conv.title.gsub(/\*\*(.+?)\*\* - /, '') %>
          <li class="conversation-item <%= 'active' if conv.id == @conversation.id %>"
              data-conversation-id="<%= conv.id %>">
            <%= link_to ask_path(id: conv.id, agent_id: session[:agent_id]),
                        class: "conversation-title",
                        aria: { current: (conv.id == @conversation.id ? 'page' : nil) } do %>
              <%= safe_title %>
            <% end %>
            <%= button_to "✕", delete_conversation_path(conv), method: :delete,
                form_class: "inline-delete-form", class: "delete-btn" %>
            <div class="tooltip"><%= tooltip_title %></div>
          </li>
        <% end %>
      </ul>
      
      <%= button_to "New Chat  +", new_chat_path,
      method: :post,
      form: { data: { turbo: false } },
      class: "new-chat-btn" %>
  </div>

  <!-- Main chat area -->
  <div class="llm-main">
    <!-- Header -->
    <div class="llm-chat-header">
      <div id="header-toggle-placeholder">
        <div id="header-toggle-spacer">☰</div>
      </div>
      <div class="logo-container">
        <%= image_tag "logo.png", alt: "LPC Logo", class: "logo" %>
      </div>
      <div class="heading-group">
        <h1>Ask the LPC AI Agent</h1>
        <h3>Your internal assistant for everything Lloyd</h3>
      </div>
      <div class="llm-agent-controls">
        <div class="agent-action-group">

          <%= link_to notifications_path, class: "notification-bell", data: { turbo: false } do %>
            <%= image_tag "bell.svg", alt: "Notifications", class: "bell-icon" %>
            <% if @has_updates %>
              <span class="bell-dot"></span>
            <% end %>
            <span class="tooltip">Notifications</span>
          <% end %>

          <%= button_to "Logout", logout_path, method: :delete, class: "logout-button", form_class: "logout-form" %>
          <%= link_to root_path, class: "agent-link", data: { turbo: false } do %>
            <span class="agent-label">
              <%= agent_name(session[:agent_id]) %>
              <%= image_tag("switch.svg", alt: "Switch Agent", class: "switch-icon") %>
              <span class="tooltip">Switch Agent</span>
            </span>
          <% end %>
        </div>
      </div>
      <button id="header-extra-toggle" class="header-extra-toggle">☰</button>
      <div id="header-extra" class="header-extra">
        <button class="header-extra-close" id="header-extra-close" aria-label="Close dropdown">&times;</button>
        <div class="agent-action-group">
          <%= link_to notifications_path, class: "notification-bell", data: { turbo: false } do %>
            <%= image_tag "bell.svg", alt: "Notifications", class: "bell-icon" %>
            <% if @has_updates %>
              <span class="bell-dot"></span>
            <% end %>
            <span class="tooltip">Notifications</span>
          <% end %>
          <%= button_to "Logout", logout_path, method: :delete, class: "logout-button", form_class: "logout-form" %>
          <%= link_to root_path, class: "agent-link", data: { turbo: false } do %>
            <span class="agent-label">
              <%= agent_name(session[:agent_id]) %>
              <%= image_tag("switch.svg", alt: "Switch Agent", class: "switch-icon") %>
              <span class="tooltip">Switch Agent</span>
            </span>
          <% end %>
        </div>
      </div>
    </div>
  
  

    <!-- Chat container -->
    <div class="llm-chat-container">

      <!-- Chat messages -->
      <div id="llm-chat-log">
      <% @conversation.messages.order(:created_at).each do |msg| %>
        <% next if msg.role == "system" %>
        <div class="llm-message-row">
          <% if msg.role == "user" %>
            <div class="llm-message llm-user"><%= h(msg.content) %></div>
          <% else %>
            <% animate = (msg.id == @last_bot_message_id) %>
            <div class="llm-message llm-bot" <%= 'data-animate="true"' if animate %>>
              <% rendered = markdown(msg.content) %>
              <%= rendered.present? ? raw(rendered) : content_tag(:p, h(msg.content), class: "llm-message-plain") %>
    
              <% if msg.usage.present? %>
                <div class="usage-dropdown-wrapper usage-in-bubble">
                  <button type="button" class="usage-toggle" aria-haspopup="true" aria-expanded="false" title="Details">Details ▾</button>
                  <div class="usage-menu hidden" role="menu" aria-label="Token and cost details">
                    <div class="usage-menu-inner">
                      <div class="usage-section" style="white-space: nowrap;">
                        <div>Prompt tokens: <%= msg.usage["prompt_tokens"] %></div>
                        <div>Completion tokens: <%= msg.usage["completion_tokens"] %></div>
                        <div>Total tokens: <%= msg.usage["total_tokens"] %></div>
                      </div>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

      <!-- Form -->
      <div class="llm-form-row">
        <form id="chat-form" data-conversation-id="<%= @conversation.id %>" action="/ask/<%= @conversation.id %>" method="post">
          <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">

          <div class="llm-form-inner">
            <textarea name="prompt" class="llm-input" rows="2" placeholder="Ask <%= agent_name(session[:agent_id]) %> a question..."></textarea>
            <select id="language-select" class="lang-select">
              <option value="en-US">English</option>
              <option value="es-US">Español</option>
            </select>
            <button type="button" id="start-recording" class="llm-mic-button">
              <%= image_tag "mic.svg", alt: "Record", class: "mic-icon", id: "mic-icon",
                data: { mic: asset_path("mic.svg"), recording: asset_path("recording.svg") } %>
            </button>
            <span id="recording-status" style="margin-left: 10px;"></span>
            <button type="submit" class="llm-send">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="white" viewBox="0 0 24 24" transform="translate(1, 0)">
                <path d="M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </form>
      </div>

    </div> <!-- end llm-chat-container -->
  </div> <!-- end llm-main -->
</div> <!-- end llm-app-container -->

